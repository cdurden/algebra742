{% extends "CompleteTableQuestion.html" %}
{% from "macros.html" import question_container_selector without context%}
{% block head %}
{{ super() }}
<script>
var draggable;
var droppable;
var lastDropzoneTarget;
var rect1;
loadScript("https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.8/lib/draggable.bundle.js", function() {
    draggable = new Draggable.Draggable(document.querySelectorAll('{{- question_container_selector(question) }} .container'), {
      delay: 5,
      //sensors: [Draggable.Sensors.DragSensor],
      mirror: {
        constrainDimensions: true,
        cursorOffsetX: 0,
        cursorOffsetY: 0,
        appendTo: 'body',
      },
      draggable: '.item'
    })
    .on('touchstart',  function(e) {
        console.log('touchstart');
        console.log(e);
    })
    .on('drag:start',  function(e) {
        console.log('drag:start');
        console.log(e);
        lastDropzoneTarget = null;
    })
    .on('mirror:move',  function(e) {
        //console.log(e);
        //console.log('mirror:move');
        rect1 = e.data.mirror.getBoundingClientRect();
    })
    .on('drag:move',  function(e) {
        //console.log(e);
        //console.log('drag:move');
        //rect1 = e.originalSource.getBoundingClientRect();
        //rect1 = e.sensorEvent.target.getBoundingClientRect();
        if (e.sensorEvent.target.classList.contains('dropzone')) {
            lastDropzoneTarget = e.sensorEvent.target;
        } else {
            lastDropzoneTarget = null;
        }
    })
    .on('drag:stop',  function(e) {
        var max_overlap_area = 0;
        var dropzoneTarget = null;
        console.log(e);
        console.log('drag:stop');
        if (lastDropzoneTarget != null) {
            payload = e.originalSource.getAttribute("data-payload");
            lastDropzoneTarget.value=payload;
        } else {
            $('{{- question_container_selector(question) -}}').find('.dropzone').each(function() {
                rect2 = this.getBoundingClientRect();
                var overlap_area = Math.max(Math.min(rect1.right,rect2.right)-Math.max(rect1.left,rect2.left),0)*Math.max(Math.min(rect1.bottom,rect2.bottom)-Math.max(rect1.top,rect2.top),0);
                if (overlap_area > max_overlap_area) {
                    max_overlap_area = overlap_area;
                    dropzoneTarget = this;
                }
            });
            if (dropzoneTarget != null) {
                payload = e.originalSource.getAttribute("data-payload");
                dropzoneTarget.value=payload;
            }
        }
        lastDropzoneTarget = null;
        dropzoneTarget = null;
        e.cancel();
    });
    //sensor = new Draggable.Sensors.DragSensor(document.querySelectorAll('{{- question_container_selector(question) -}}'),{});
  /*
  .on('drag:start', () => console.log('drag:start'))
  .on('drag:move',  () => console.log('drag:move'))
  .on('drag:stop',  () => console.log('drag:stop'));
    droppable = new Draggable.Droppable(document.querySelectorAll('{{- question_container_selector(question) -}}'), {
  draggable: '.item',
  dropzone: '.dropzone'
});
    droppable.on('droppable:dropped', function(e) {
        console.log('droppable:dropped');
        console.log(e);
        //console.log(e.dragEvent.originalSource);
        console.log(e.dragEvent.originalSource.getAttribute("data-payload"));
        payload = e.dragEvent.originalSource.getAttribute("data-payload");
        e.dropzone.setAttribute("value",payload);
        e.cancel();
    });
    droppable.on('droppable:returned', () => console.log('droppable:returned'));
*/
    $('{{- question_container_selector(question) -}}').find('input').addClass('dropzone');
});
</script>
{% endblock %}
{% block content %}
{{ super() }}
<center>
<div class="container" data-prevent-swipe="true">
    {% for block in blocks %}
    <div class="item" data-payload="{{ block }}">{{ block }}</div>
    {% endfor %}
</div>
</center>
{% endblock %}
